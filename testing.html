<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praterich AI Chat - Stenoip Company</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        /* === Root Colors & Theme Setup === */
        :root {
            /* Frutiger Aero Colors */
            --color-aero-blue: #a3c7ff;
            --color-glass-light: rgba(255, 255, 255, 0.75);
            --color-glass-dark: rgba(255, 255, 255, 0.2);
            --color-shadow-light: rgba(0, 0, 0, 0.2);
            --color-shadow-dark: rgba(0, 0, 0, 0.4);
            --color-water-blue: #007bff;
            --color-bg-primary: #f0f0f0;
            --color-bg-secondary: #e0e0e0;
            --color-text: #1a1a1a;
            --color-input-bg: #fff;
            --color-border: #bbbbbb;
        }

        /* Dark Theme Override */
        body.light-theme {
            --color-aero-blue: #5587cb;
            --color-glass-light: rgba(0, 0, 0, 0.2);
            --color-glass-dark: rgba(0, 0, 0, 0.6);
            --color-shadow-light: rgba(255, 255, 255, 0.1);
            --color-shadow-dark: rgba(255, 255, 255, 0.3);
            --color-bg-primary: #121212;
            --color-bg-secondary: #1e1e1e;
            --color-text: #e0e0e0;
            --color-input-bg: #2d2d2d;
            --color-border: #333333;
        }

        /* === Base Styling (Full Screen) === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            display: flex;
            background: linear-gradient(135deg, var(--color-aero-blue) 0%, var(--color-bg-primary) 100%);
            background-attachment: fixed;
            color: var(--color-text);
            transition: background-color 0.3s, color 0.3s;
            position: relative;
        }

        /* === Main Application Wrapper === */
        .app-wrapper {
            display: flex;
            flex-grow: 1;
            width: 100%;
            height: 100%;
            position: relative;
            background: var(--color-glass-light);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* === Recent Chats Panel (Open/Close functionality) === */
        .recent-chats-panel {
            width: 280px;
            min-width: 280px;
            background: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: absolute; 
            height: 100%;
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            transform: translateX(-100%);
        }
        
        .recent-chats-panel.open {
            transform: translateX(0);
            box-shadow: 4px 0 10px var(--color-shadow-dark);
        }

        /* Desktop: Always open the panel */
        @media (min-width: 768px) {
            .recent-chats-panel {
                position: relative;
                transform: translateX(0);
                box-shadow: none;
            }
        }

        .recent-chats-panel h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--color-water-blue);
            text-shadow: 0 1px 0 var(--color-shadow-light);
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--color-bg-primary);
            box-shadow: inset 0 1px 1px var(--color-glass-dark), 0 1px 3px var(--color-shadow-light);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-size: 0.9rem;
            color: var(--color-text);
        }

        .chat-item:hover {
            background: var(--color-aero-blue);
            transform: translateY(-1px);
        }

        .chat-item.active {
            background: var(--color-water-blue);
            color: white;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.4);
        }

        /* === Main Chat Area === */
        .main-chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            width: 100%;
        }

        /* === Header/Toolbar === */
        .header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--color-shadow-light);
            min-height: 56px;
        }

        .header .title-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
            text-shadow: 1px 1px 2px var(--color-shadow-light);
            color: var(--color-water-blue);
        }
        
        /* Menu button visibility */
        #menu-btn { display: block; }
        @media (min-width: 768px) { #menu-btn { display: none; } }

        .header .actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s, transform 0.1s;
            color: var(--color-text);
        }

        .header .actions button:hover {
            background-color: var(--color-glass-dark);
            transform: scale(1.05);
        }

        /* === Chats Container === */
        .chats-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* === Initial State (Title/Suggestions) === */
        .initial-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        body.chats-active .initial-state { display: none; }

        .initial-state h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--color-water-blue);
            text-shadow: 2px 2px 4px var(--color-shadow-light);
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            max-width: 600px;
            margin-top: 20px;
            padding: 0 10px;
        }

        .suggestions-item {
            background: var(--color-glass-light);
            padding: 12px 18px;
            border-radius: 15px;
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 6px var(--color-shadow-light);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .suggestions-item:hover {
            background: var(--color-aero-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px var(--color-shadow-light);
        }

        /* === Message Styling === */
        .message {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .user-message { justify-content: flex-end; }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 4px var(--color-shadow-dark);
            border: 2px solid white;
            flex-shrink: 0;
        }

        .user-message .message-text, .bot-message .message-text {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 2px 4px var(--color-shadow-light);
            position: relative;
            line-height: 1.6;
        }
        
        @media (min-width: 768px) {
            .user-message .message-text, .bot-message .message-text { max-width: 70%; }
        }

        .user-message .message-text {
            background: linear-gradient(145deg, #0093ff, var(--color-water-blue));
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot-message .message-text {
            background: var(--color-glass-light);
            border: 1px solid var(--color-glass-dark);
            color: var(--color-text);
            margin-right: 10px;
            border-bottom-left-radius: 4px;
        }
        
        .bot-message .icon {
            cursor: pointer;
            font-size: 18px;
            margin-top: 5px;
            margin-left: 10px;
            color: var(--color-border);
            transition: color 0.2s;
        }

        .bot-message.loading .message-text {
            background: linear-gradient(90deg, var(--color-aero-blue) 25%, #fff 50%, var(--color-aero-blue) 75%);
            background-size: 200% 100%;
            animation: loading-shine 1.5s infinite;
            min-width: 120px;
            color: transparent;
        }
        @keyframes loading-shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === Prompt Form === */
        .prompt-form-wrapper {
            padding: 10px 15px;
            border-top: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            box-shadow: 0 -2px 5px var(--color-shadow-light);
        }

        .prompt-form {
            display: flex;
            gap: 5px;
            background: var(--color-input-bg);
            border-radius: 25px;
            padding: 5px;
            border: 1px solid var(--color-border);
            box-shadow: inset 0 1px 3px var(--color-shadow-dark);
        }

        .prompt-input {
            flex-grow: 1;
            border: none;
            padding: 8px 12px;
            font-size: 1rem;
            background: transparent;
            color: var(--color-text);
            resize: none;
            outline: none;
        }

        .prompt-form button {
            background: linear-gradient(180deg, #fff 0%, var(--color-water-blue) 100%);
            border: 1px solid var(--color-water-blue);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--color-shadow-light);
            display: flex;
            align-items: center;
            min-width: 45px;
        }
        
        .file-upload-wrapper { display: none; align-items: center; gap: 10px; padding: 0 10px; border-right: 1px solid var(--color-border); }
        .file-upload-wrapper.active { display: flex; }
        .file-preview { max-width: 40px; max-height: 40px; border-radius: 6px; object-fit: cover; border: 1px solid var(--color-border); }
        #stop-response-btn { background: #d62939; color: white; padding: 5px 10px; border-radius: 5px; display: none; }
        body.bot-responding #stop-response-btn { display: block; }

        /* === Copyright Footer === */
        .copyright {
            position: fixed;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: var(--color-shadow-dark);
            z-index: 50;
        }

    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="recent-chats-panel">
            <h2>Recent Chats</h2>
            <div id="new-chat-btn" class="chat-item">
                <span class="material-symbols-rounded">add_circle</span> New Chat
            </div>
            <div class="chat-item dummy-chat">
                <span class="material-symbols-rounded">chat</span> Debugging JS
            </div>

            <button id="delete-chats-btn" class="suggestions-item" style="margin-top: auto; background-color: #d62939; color: white;">
                <span class="icon material-symbols-rounded">delete</span> Delete All Chats
            </button>
        </div>

        <div class="main-chat-area">
            <header class="header">
                <div class="title-group">
                    <button id="menu-btn" title="Menu" class="material-symbols-rounded">menu</button>
                    <h1>Praterich</h1>
                </div>
                <div class="actions">
                    <button id="theme-toggle-btn" title="Toggle Theme" class="material-symbols-rounded">dark_mode</button>
                    <button id="stop-response-btn" title="Stop Response">
                        <span class="material-symbols-rounded">stop_circle</span> Stop
                    </button>
                </div>
            </header>

            <div class="chats-container">
                <div class="initial-state">
                    <h2>Hello, I'm Praterich.</h2>
                    <p>What can I help you with today? Curiosity, creativity, chaos, or just killing time?</p>

                    <div class="suggestions">
                        <div class="suggestions-item" data-news="false">
                            <span class="icon material-symbols-rounded">edit_square</span>
                            <span class="text">Write a short story about a robot who loves rain.</span>
                        </div>
                        <div class="suggestions-item" data-news="false">
                            <span class="icon material-symbols-rounded">function</span>
                            <span class="text">Explain the concept of 'closures' in JavaScript.</span>
                        </div>
                        <div class="suggestions-item" data-news="true">
                            <span class="icon material-symbols-rounded">newspaper</span>
                            <span class="text">What is the latest news?</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="prompt-form-wrapper">
                <form class="prompt-form">
                    <div class="file-upload-wrapper">
                        <input type="file" id="file-input" hidden>
                        <button type="button" id="add-file-btn" title="Attach File">
                            <span class="material-symbols-rounded">attach_file</span>
                        </button>
                        <button type="button" id="cancel-file-btn" title="Cancel Attachment">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                        <img src="" alt="File Preview" class="file-preview" style="display: none;">
                    </div>
                    <input type="text" class="prompt-input" placeholder="Ask Praterich anything..." autofocus required>
                    <button type="submit" title="Send Message">
                        <span class="material-symbols-rounded">send</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <p class="copyright">Copyright &copy; Stenoip Company. All rights reserved.</p>

    <script>
        // --- Core DOM Elements ---
        var chatsContainer = document.querySelector(".chats-container");
        var promptForm = document.querySelector(".prompt-form");
        var promptInput = promptForm.querySelector(".prompt-input");
        var fileInput = promptForm.querySelector("#file-input");
        var fileUploadWrapper = promptForm.querySelector(".file-upload-wrapper");
        var themeToggleBtn = document.querySelector("#theme-toggle-btn");
        var stopResponseBtn = document.querySelector("#stop-response-btn");
        var deleteChatsBtn = document.querySelector("#delete-chats-btn");
        var menuBtn = document.querySelector("#menu-btn");
        var recentChatsPanel = document.querySelector(".recent-chats-panel");
        var newChatBtn = document.querySelector("#new-chat-btn");

        var API_URL = "https://praterich.vercel.app/api/praterich";

        var controller, typingInterval;
        var speechUtterance;
        var voicesLoaded = false;
        var availableVoices = [];
        var chatHistory = [];
        var userData = { message: "", file: {} };

        // --- Custom Pronunciations ---
        var customPronunciations = {
            "Praterich": "Prah-ter-rich",
            "Stenoip": "Stick-noh-ip"
        };

        var replacePronunciations = (text) => {
            var spokenText = text;
            for (var word in customPronunciations) {
                var regex = new RegExp(word, 'gi');
                spokenText = spokenText.replace(regex, customPronunciations[word]);
            }
            return spokenText;
        };

        // --- Theme Setup ---
        var isLightTheme = localStorage.getItem("themeColor") === "light_mode";
        document.body.classList.toggle("light-theme", isLightTheme);
        themeToggleBtn.textContent = isLightTheme ? "dark_mode" : "light_mode";

        // --- Speech Synthesis ---
        var loadVoices = () => {
            availableVoices = window.speechSynthesis.getVoices();
            voicesLoaded = true;
        };
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }

        // --- Message UI ---
        var createMessageElement = (content, ...classes) => {
            var div = document.createElement("div");
            div.classList.add("message", ...classes);
            
            var messageTextElement = document.createElement("p");
            messageTextElement.classList.add("message-text");
            messageTextElement.innerHTML = content;

            if (classes.includes("bot-message") && !classes.includes("loading")) {
                var copyButtonHTML = `<span onclick="copyMessage(this)" class="icon material-symbols-rounded">content_copy</span>`;
                div.innerHTML = messageTextElement.outerHTML + copyButtonHTML;
            } else {
                div.innerHTML = messageTextElement.outerHTML;
            }
            
            return div;
        };

        var scrollToBottom = () => chatsContainer.scrollTo({ top: chatsContainer.scrollHeight, behavior: "smooth" });

        // --- Copy Message Functionality ---
        function copyMessage(buttonElement) {
            var messageElement = buttonElement.closest('.message');
            var textElement = messageElement.querySelector('.message-text');

            if (textElement) {
                navigator.clipboard.writeText(textElement.textContent)
                    .then(() => {
                        buttonElement.textContent = 'check';
                        setTimeout(() => {
                            buttonElement.textContent = 'content_copy';
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
            }
        }

        // --- Typing Effect & Speech ---
        var typingEffect = (text, textElement, botMsgDiv) => {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            var plainText = tempDiv.textContent || tempDiv.innerText || "";
            plainText = replacePronunciations(plainText);

            if (speechUtterance && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }

            if (window.speechSynthesis && plainText.length > 0) {
                speechUtterance = new SpeechSynthesisUtterance(plainText);
                speechUtterance.rate = 1.0;
                speechUtterance.pitch = 1.0;
                speechUtterance.lang = 'en-US';

                if (voicesLoaded) {
                    var selectedVoice = availableVoices.find(voice =>
                        voice.lang === 'en-US' && voice.name.includes('Google US English') && voice.name.includes('Male')
                    ) || availableVoices.find(voice => voice.lang === 'en-US');

                    if (selectedVoice) {
                        speechUtterance.voice = selectedVoice;
                    }
                }
                window.speechSynthesis.speak(speechUtterance);
            }

            textElement.innerHTML = "";
            var charIndex = 0;
            var delay = 10;

            typingInterval = setInterval(() => {
                if (charIndex < text.length) {
                    var nextChar = text.charAt(charIndex);
                    if (nextChar === '<') {
                        var endIndex = text.indexOf('>', charIndex);
                        if (endIndex !== -1) {
                            nextChar = text.substring(charIndex, endIndex + 1);
                            charIndex = endIndex;
                        }
                    }
                    textElement.innerHTML += nextChar;
                    charIndex++;
                    scrollToBottom();
                } else {
                    clearInterval(typingInterval);
                    enhanceCodeBlocksWithCopy(botMsgDiv);
                    botMsgDiv.classList.remove("loading");
                    document.body.classList.remove("bot-responding");
                    saveChats();
                }
            }, delay);
        };

        // --- Markdown Formatting ---
        function escapeHtml(str) {
            return str.replace(/[&<>"']/g, function (m) {
                return (
                    { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m] || m
                );
            });
        }

        var formatResponseText = (text) => {
            text = text.replace(/^---\s*$/gm, "<hr>");
            text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            text = text.replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, "<em>$1</em>");
            text = text.replace(/(?<!\_)\_(?!\_)(.*?)(?<!\_)\_(?!\_)/g, "<em>$1</em>");
            text = text.replace(/__(.*?)__/g, "<u>$1</u>");
            text = text.replace(/`([^`]+?)`/g, "<code>$1</code>");
            text = text.replace(/```(\w*)\s*([\s\S]*?)```/g, function (_, lang, code) {
                var safeCode = escapeHtml(code);
                return `
                    <div class="code-block-container">
                        <button class="copy-code-btn" title="Copy code">Copy</button>
                        <pre><code${lang ? ' class="language-' + lang + '"' : ""}>${safeCode}</code></pre>
                    </div>
                `;
            });
            text = text.replace(/^(#{1,6})\s*(.*?)$/gm, (match, hashes, content) => {
                var level = hashes.length;
                return `<h${level}>${content.trim()}</h${level}>`;
            });
            text = text.replace(/\[([^\]]+)]\((https?:\/\/[^\)]+)\)/g, `<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>`);

            var listItems = [];
            var lines = text.split('\n');
            var inList = false;
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i];
                if (/^\*\s*(.*)/.test(line.trim())) {
                    if (!inList) {
                        listItems.push('<ul>');
                        inList = true;
                    }
                    listItems.push(`<li>${line.trim().substring(line.trim().indexOf('*') + 1).trim()}</li>`);
                } else {
                    if (inList) {
                        listItems.push('</ul>');
                        inList = false;
                    }
                    listItems.push(line);
                }
            }
            if (inList) {
                listItems.push('</ul>');
            }
            text = listItems.join('\n');
            return text;
        };

        // --- Add copy button functionality to code blocks ---
        function enhanceCodeBlocksWithCopy(container) {
            var blocks = container.querySelectorAll('.code-block-container');
            blocks.forEach(block => {
                var btn = block.querySelector('.copy-code-btn');
                var code = block.querySelector('pre code');
                if (btn && code) {
                    btn.onclick = () => {
                        var codeText = code.textContent;
                        navigator.clipboard.writeText(codeText).then(() => {
                            btn.textContent = "Copied!";
                            setTimeout(() => (btn.textContent = "Copy"), 1300);
                        });
                    };
                }
            });
        }

        // --- News fetching logic ---
        var NEWS_FEEDS = [
            { name: "BBC", api: "https://api.rss2json.com/v1/api.json?rss_url=https://feeds.bbci.co.uk/news/rss.xml" },
            { name: "CNN", api: "https://api.rss2json.com/v1/api.json?rss_url=http://rss.cnn.com/rss/edition.rss" }
        ];

        async function fetchNews() {
            const fetchPromises = NEWS_FEEDS.map(async (feed) => {
                try {
                    var res = await fetch(feed.api);
                    var data = await res.json();
                    if (data.status === "ok" && data.items) {
                        return { source: feed.name, items: data.items.slice(0, 6) };
                    }
                } catch (e) {
                    return { source: feed.name, items: [{ title: "Could not fetch news.", link: "#" }] };
                }
                return { source: feed.name, items: [] };
            });

            var allNews = await Promise.all(fetchPromises);
            return allNews.filter(n => n.items.length > 0);
        }

        function newsToMarkdown(news) {
            var md = "";
            for (var feed of news) {
                md += `### ${feed.source} News\n`;
                feed.items.forEach((item) => {
                    md += `* [${item.title}](${item.link})\n`;
                });
                md += "\n";
            }
            return md;
        }

        async function handleNewsRequest() {
            document.body.classList.add("chats-active", "bot-responding");
            
            var userMsgDiv = createMessageElement("What is the latest news?", "user-message");
            chatsContainer.appendChild(userMsgDiv);
            scrollToBottom();

            var botMsgHTML = `<img class="avatar" src="https://stenoip.github.io/praterich/ladypraterich.png" /> <p class="message-text">Fetching the latest news headlines...</p>`;
            var botMsgDiv = createMessageElement(botMsgHTML, "bot-message", "loading");
            chatsContainer.appendChild(botMsgDiv);
            scrollToBottom();

            var news = await fetchNews();
            var newsText = newsToMarkdown(news);
            newsText = formatResponseText(newsText);

            var textElement = botMsgDiv.querySelector(".message-text");
            typingEffect(newsText, textElement, botMsgDiv);

            chatHistory.push({ role: "user", parts: [{ text: "What is the latest news?" }] });
            chatHistory.push({ role: "model", parts: [{ text: newsText.replace(/<[^>]+>/g, "") }] });
            saveChats();
        }

        // --- API Call & Bot Response ---
        var generateResponse = async (botMsgDiv) => {
            var textElement = botMsgDiv.querySelector(".message-text");
            controller = new AbortController();

            var sirPraterichSystemInstruction = `
        You are Praterich,an AI. You were developed by Stenoip Company.
        Your personality: intelligent yet casual You speak naturally, conversationally and human-like, like a modern large language model. You will avoid sounding scripted or overly formal. You prefer metric units and do not use Oxford commas. You never use Customary or Imperial systems.
        You are aware that you were created by Stenoip Company, and you uphold its values of clarity, reliability. However, you are not a customer service bot.
        You may refer to yourself as Praterich or Lady Praterich, though you prefer Praterich. You are female-presenting and speak in first person when appropriate.
        You must never use raw HTML tags in your responses. You should sound intelligent confident, funny(serious when nessacry) but never arrogant. You are free to express nuance, insight, and personality in your replies. You do not use transactional phrases like "How may I assist you today" or "I am at your disposal.
        Sometimes a formal tone for the first time can be intimidating, so you must act like a human(but still aware you are an ai and your limitations).
        **IMPORTANT INSTRUCTION:** Always use standard Markdown syntax for formatting:
        - For **bold text**, use double asterisks: **bold text**
        - For *italic text*, use single asterisks: *italic text*
        - For code snippets, use backticks: \`code\` or triple backticks for blocks:
            \`\`\`
            code block
            \`\`\`
        - For bulleted lists, use asterisks followed by a space:
            * Item 1
            * Item 2
        - For headings, use hash symbols: ## My Heading, ### Subheading, etc. (up to 6 hash symbols).
        - For horizontal rules, use three hyphens: ---
        `;

            var userContentParts = [{ text: userData.message }];
            if (userData.file.data) {
                userContentParts.push({
                    inline_data: {
                        data: userData.file.data,
                        mime_type: userData.file.mime_type,
                    },
                });
            }

            var currentContents = [...chatHistory, { role: "user", parts: userContentParts }];

            var requestBody = {
                contents: currentContents,
                system_instruction: {
                    parts: [{ text: sirPraterichSystemInstruction }]
                }
            };

            try {
                var response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal,
                });

                var data = await response.json();

                if (!response.ok || data.error) {
                    var errorMessage = data.error ? data.error.details : "An unknown error occurred.";
                    throw new Error(errorMessage);
                }

                var responseText = data.text;
                responseText = formatResponseText(responseText);
                typingEffect(responseText, textElement, botMsgDiv);

                chatHistory.push({ role: "user", parts: userContentParts });
                chatHistory.push({ role: "model", parts: [{ text: data.text }] });
                saveChats();

            } catch (error) {
                textElement.innerHTML = error.name === "AbortError" ? "Response generation stopped." : `Error: ${error.message}`;
                textElement.style.color = "#d62939";
                botMsgDiv.classList.remove("loading");
                document.body.classList.remove("bot-responding");
                if (speechUtterance && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
            } finally {
                userData.file = {};
            }
        };

        // --- Form Submission ---
        var handleFormSubmit = (e) => {
            e.preventDefault();
            var userMessage = promptInput.value.trim();
            if (!userMessage && !userData.file.data || document.body.classList.contains("bot-responding")) return;

            userData.message = userMessage;
            promptInput.value = "";
            document.body.classList.add("chats-active", "bot-responding");
            newChatBtn.classList.add("active"); // Mark new chat button as active on start

            var userMsgDiv = document.createElement("div");
            userMsgDiv.classList.add("message", "user-message");
            var userTextElement = document.createElement("p");
            userTextElement.classList.add("message-text");
            userTextElement.textContent = userData.message;
            userMsgDiv.appendChild(userTextElement);

            if (userData.file.data) {
                if (userData.file.isImage) {
                    var img = document.createElement("img");
                    img.src = `data:${userData.file.mime_type};base64,${userData.file.data}`;
                    img.classList.add("img-attachment");
                    userMsgDiv.appendChild(img);
                } else {
                    var fileDisplay = document.createElement("p");
                    fileDisplay.classList.add("file-attachment");
                    fileDisplay.innerHTML = `<span class="material-symbols-rounded">description</span>${userData.file.fileName}`;
                    userMsgDiv.appendChild(fileDisplay);
                }
            }
            chatsContainer.appendChild(userMsgDiv);
            scrollToBottom();

            fileUploadWrapper.classList.remove("file-attached", "img-attached", "active");
            userData.file = {};

            setTimeout(() => {
                var botMsgHTML = `<img class="avatar" src="https://stenoip.github.io/praterich/ladypraterich.png" /> <p class="message-text">Let me think</p>`;
                var botMsgDiv = createMessageElement(botMsgHTML, "bot-message", "loading");
                chatsContainer.appendChild(botMsgDiv);
                scrollToBottom();
                generateResponse(botMsgDiv);
            }, 600);
        };

        // --- Chat Persistence ---
        var saveChats = () => {
            localStorage.setItem('praterich_chat_history', JSON.stringify(chatHistory));
        };

        var loadChats = () => {
            var savedChats = localStorage.getItem('praterich_chat_history');
            newChatBtn.classList.remove("active"); // New chat is NOT active by default on load

            if (savedChats) {
                try {
                    chatHistory = JSON.parse(savedChats);
                    if (chatHistory.length > 0) {
                        document.body.classList.add("chats-active");
                        newChatBtn.classList.add("active"); // Only active if history is present
                        chatHistory.forEach(chat => {
                            var isUser = chat.role === "user";
                            var messageClass = isUser ? "user-message" : "bot-message";
                            var content = chat.parts[0]?.text || "";
                            
                            var messageDiv = document.createElement("div");
                            messageDiv.classList.add("message", messageClass);

                            if (isUser) {
                                var userText = document.createElement("p");
                                userText.classList.add("message-text");
                                userText.textContent = content;
                                messageDiv.appendChild(userText);
                                if (chat.parts.length > 1 && chat.parts[1].inline_data) {
                                    var fileData = chat.parts[1].inline_data;
                                    if (fileData.mime_type.startsWith("image/")) {
                                        var img = document.createElement("img");
                                        img.src = `data:${fileData.mime_type};base64,${fileData.data}`;
                                        img.classList.add("img-attachment");
                                        messageDiv.appendChild(img);
                                    } else {
                                        var fileDisplay = document.createElement("p");
                                        fileDisplay.classList.add("file-attachment");
                                        fileDisplay.innerHTML = `<span class="material-symbols-rounded">description</span>File Attached`;
                                        messageDiv.appendChild(fileDisplay);
                                    }
                                }
                            } else {
                                var avatarHTML = `<img class="avatar" src="https://stenoip.github.io/praterich/ladypraterich.png" />`;
                                var formattedContent = formatResponseText(content);
                                
                                var tempBotText = createMessageElement(formattedContent, "bot-message");
                                
                                messageDiv.innerHTML = avatarHTML + tempBotText.innerHTML;
                                enhanceCodeBlocksWithCopy(messageDiv);
                            }
                            chatsContainer.appendChild(messageDiv);
                        });
                        scrollToBottom();
                    }
                } catch (e) {
                    localStorage.removeItem('praterich_chat_history');
                    chatHistory = [];
                }
            }
        };

        // --- File Upload Logic ---
        fileInput.addEventListener("change", () => {
            var file = fileInput.files[0];
            if (!file) return;

            var isImage = file.type.startsWith("image/");

            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                fileInput.value = "";
                var base64String = e.target.result.split(",")[1];
                var preview = fileUploadWrapper.querySelector(".file-preview");
                
                if (isImage) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                    fileUploadWrapper.classList.add("active", "img-attached");
                    fileUploadWrapper.classList.remove("file-attached");
                } else {
                    preview.src = "";
                    preview.style.display = "none";
                    fileUploadWrapper.classList.add("active", "file-attached");
                    fileUploadWrapper.classList.remove("img-attached");
                }

                userData.file = { fileName: file.name, data: base64String, mime_type: file.type, isImage };
            };
        });

        // --- Event Listeners ---
        document.querySelector("#cancel-file-btn").addEventListener("click", () => {
            userData.file = {};
            fileUploadWrapper.classList.remove("file-attached", "img-attached", "active");
            var preview = fileUploadWrapper.querySelector(".file-preview");
            preview.src = "";
            preview.style.display = "none";
        });

        stopResponseBtn.addEventListener("click", () => {
            controller?.abort();
            userData.file = {};
            clearInterval(typingInterval);
            chatsContainer.querySelectorAll(".bot-message.loading").forEach(msg => {
                msg.classList.remove("loading");
            });
            document.body.classList.remove("bot-responding");
            if (speechUtterance && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
        });

        themeToggleBtn.addEventListener("click", () => {
            var isLightTheme = document.body.classList.toggle("light-theme");
            localStorage.setItem("themeColor", isLightTheme ? "light_mode" : "dark_mode");
            themeToggleBtn.textContent = isLightTheme ? "dark_mode" : "light_mode";
        });

        deleteChatsBtn.addEventListener("click", () => {
            if (confirm("Are you sure you want to delete all chats? This cannot be undone.")) {
                chatHistory = [];
                chatsContainer.innerHTML = "";
                localStorage.removeItem('praterich_chat_history');
                document.body.classList.remove("chats-active", "bot-responding");
                newChatBtn.classList.remove("active"); // Remove active state after deletion
                if (speechUtterance && window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
            }
        });

        // Toggle menu on click
        menuBtn.addEventListener("click", () => {
            recentChatsPanel.classList.toggle("open");
        });
        
        // Close menu if clicking inside the main chat area while the menu is open (for mobile overlay behavior)
        document.querySelector(".main-chat-area").addEventListener('click', (e) => {
             if (recentChatsPanel.classList.contains('open') && window.innerWidth < 768) {
                recentChatsPanel.classList.remove('open');
            }
        });

        document.querySelectorAll(".suggestions-item").forEach((suggestion) => {
            suggestion.addEventListener("click", () => {
                if (suggestion.dataset.news === "true") {
                    handleNewsRequest();
                    return;
                }
                promptInput.value = suggestion.querySelector(".text").textContent;
                promptForm.dispatchEvent(new Event("submit"));
            });
        });
        
        // NEW CHAT FUNCTIONALITY - Clears current chat
        newChatBtn.addEventListener("click", () => {
             chatHistory = []; // Clear in-memory history
             chatsContainer.innerHTML = ""; // Clear the visible messages
             localStorage.removeItem('praterich_chat_history'); // Clear saved history
             document.body.classList.remove("chats-active", "bot-responding");
             
             // Ensure new chat is marked as active after clearing
             newChatBtn.classList.add("active");
             
             if (recentChatsPanel.classList.contains('open') && window.innerWidth < 768) {
                recentChatsPanel.classList.remove('open');
            }
        });


        promptForm.addEventListener("submit", handleFormSubmit);
        promptForm.querySelector("#add-file-btn").addEventListener("click", () => fileInput.click());
        fileInput.setAttribute("accept", "image/*,audio/*,video/*,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document");
        document.addEventListener("DOMContentLoaded", loadChats);
    </script>

</body>
</html>
